<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Plinko + Celebration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * { touch-action: manipulation; box-sizing: border-box; }
        body {
            margin: 0; padding: 10px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 100vh; background-color: #1a1a2e;
            color: white; font-family: sans-serif; overflow: hidden;
        }
        #game-container {
            width: 100%; max-width: 450px;
            aspect-ratio: 5 / 6; position: relative;
        }
        canvas {
            width: 100% !important; height: auto !important;
            border: 3px solid #16213e; border-radius: 12px;
            background: #0f3460;
        }
        .controls { margin-top: 15px; width: 100%; max-width: 450px; }
        button {
            width: 100%; padding: 20px; font-size: 22px; font-weight: bold;
            cursor: pointer; background-color: #e94560; color: white;
            border: none; border-radius: 12px; box-shadow: 0 5px #952d3e;
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px #952d3e; }
        .score-board { font-size: 24px; margin-bottom: 10px; color: #4ecca3; font-weight: bold; }
    </style>
</head>
<body>

    <div class="score-board">Score: <span id="score">0</span></div>
    <div id="game-container"></div>
    <div class="controls">
        <button id="dropBtn">DROP BALL</button>
    </div>

    <script>
        // Audio Setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playPlink(pitch = 1, type = 'sine', volume = 0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(600 * pitch, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
        const width = 500, height = 600, rows = 8;
        let totalScore = 0;
        let particles = [];

        const engine = Engine.create();
        const world = engine.world;
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width, height, wireframes: false, background: 'transparent' }
        });

        // Add Pegs
        for (let i = 0; i < rows; i++) {
            const rowPegs = i + 3;
            const spacing = width / (rowPegs + 1);
            for (let j = 0; j < rowPegs; j++) {
                const peg = Bodies.circle((j + 1) * spacing, 100 + (i * 55), 6, {
                    isStatic: true, render: { fillStyle: '#ffffff' }, label: 'peg'
                });
                Composite.add(world, peg);
            }
        }

        // Add Buckets
        const multipliers = [5, 2, 1, 0.5, 1, 2, 5];
        const bucketWidth = width / multipliers.length;
        for (let i = 0; i <= multipliers.length; i++) {
            Composite.add(world, Bodies.rectangle(i * bucketWidth, height - 35, 4, 70, {
                isStatic: true, render: { fillStyle: '#16213e' }
            }));
        }

        // Particles for celebration
        function createConfetti(x, y) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 5,
                    life: 1.0,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`
                });
            }
        }

        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach((pair) => {
                if (pair.bodyA.label === 'peg' || pair.bodyB.label === 'peg') {
                    playPlink(0.8 + Math.random() * 0.4);
                }
            });
        });

        function dropBall() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const ball = Bodies.circle(width/2 + (Math.random()*20-10), 20, 10, {
                restitution: 0.6, friction: 0.01,
                render: { fillStyle: '#e94560' }, label: 'ball'
            });
            Composite.add(world, ball);
        }

        document.getElementById('dropBtn').addEventListener('pointerdown', (e) => {
            e.preventDefault();
            dropBall();
        });

        Events.on(engine, 'afterUpdate', () => {
            // Particle physics
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                p.vy += 0.2; // Gravity
                p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            });

            // Ball scoring
            Composite.allBodies(world).forEach(body => {
                if (body.label === 'ball' && body.position.y > height - 20) {
                    const idx = Math.floor(body.position.x / bucketWidth);
                    const val = multipliers[Math.max(0, Math.min(idx, multipliers.length - 1))];
                    
                    if (val >= 2) {
                        playPlink(2, 'square', 0.15); // Higher, richer "win" sound
                        createConfetti(body.position.x, height - 40);
                    }

                    totalScore += val;
                    document.getElementById('score').innerText = totalScore.toFixed(1);
                    Composite.remove(world, body);
                }
            });
        });

        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            // Draw particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 6, 6);
            });
            ctx.globalAlpha = 1.0;

            // Draw labels
            ctx.font = 'bold 18px sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            multipliers.forEach((m, i) => {
                ctx.fillText(`${m}x`, (i * bucketWidth) + (bucketWidth / 2), height - 15);
            });
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);
    </script>
</body>
</html>
